<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Colossus Maps — MVP Demo (Dark)</title>

  <!-- Tailwind (CDN for demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: "class", theme: { extend: {} } };
  </script>

  <!-- React (dev builds for demo) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (in-browser JSX; fine for demos) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html, body { background:#0a0a0a; }
    /* Ensure the map can never collapse, even if Tailwind fails to load */
    #map { height: 400px; min-height: 320px; width: 100%; }
  </style>

  <!-- Google Maps init + dark style -->
  <script>
    const DARK_MAP_STYLE = [
      { elementType: "geometry", stylers: [{ color: "#1f2937" }]},
      { elementType: "labels.text.stroke", stylers: [{ color: "#1f2937" }]},
      { elementType: "labels.text.fill", stylers: [{ color: "#9ca3af" }]},
      { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d1d5db" }]},
      { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#a3a3a3" }]},
      { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#0b3a2b" }]},
      { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#86efac" }]},
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#374151" }]},
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#111827" }]},
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#d1d5db" }]},
      { featureType: "transit", elementType: "geometry", stylers: [{ color: "#1f2937" }]},
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }]},
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#000000" }]}
    ];

    // Called by Google Maps JS API after it loads
    window.initMap = function(){
      // Wait until React has rendered the #map node
      const start = performance.now();
      const waitForMapEl = () => {
        const el = document.getElementById("map");
        if (el) {
          // Initialize the map
          window.__gmap = new google.maps.Map(el, {
            center: { lat: 37.1, lng: -95.7 },
            zoom: 4,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            styles: DARK_MAP_STYLE,
            backgroundColor: "#0a0a0a"
          });
          window.__gmarkers = [];
          // If React already computed a filtered list, draw markers now
          if (window.__refreshMarkersPending) {
            window.__refreshMarkers(window.__refreshMarkersPending);
            window.__refreshMarkersPending = null;
          }
          return;
        }
        // Retry for up to ~3 seconds
        if (performance.now() - start < 3000) {
          requestAnimationFrame(waitForMapEl);
        }
      };
      waitForMapEl();
    };

    // Exposed so React can (re)draw markers after filters change
    window.__refreshMarkers = function(sites){
      if (!Array.isArray(sites)) return;

      // If map isn't ready yet, stash and draw on init
      if (!window.__gmap) {
        window.__refreshMarkersPending = sites;
        return;
      }

      (window.__gmarkers || []).forEach(m => m.setMap(null));
      window.__gmarkers = [];

      const bounds = new google.maps.LatLngBounds();
      const iw = new google.maps.InfoWindow();

      sites.forEach(site => {
        if (!site.lat || !site.lng) return;
        const color =
          site.readiness >= 80 ? "#10b981" :
          site.readiness >= 60 ? "#f59e0b" : "#e11d48";

        const marker = new google.maps.Marker({
          position: { lat: site.lat, lng: site.lng },
          map: window.__gmap,
          title: site.title,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 7,
            fillColor: color,
            fillOpacity: 1,
            strokeWeight: 1,
            strokeColor: "#111827"
          }
        });

        marker.addListener("click", () => {
          iw.setContent(`
            <div style="font-family:ui-sans-serif;max-width:260px;color:#e5e7eb">
              <div style="font-weight:600">${site.title}</div>
              <div style="font-size:12px;color:#9ca3af">
                ${site.state} • ${site.assetType.replace("_"," ")} • ${site.commodities.join(", ")} • ${site.stage}
              </div>
              <div style="font-size:12px;margin-top:6px;color:#d1d5db">
                Readiness: <b>${site.readiness}</b> • Timeline: <b>${site.timelineMonths} mo</b><br/>
                Capex: <b>${site.capexBand}</b>
              </div>
            </div>
          `);
          iw.open(window.__gmap, marker);
        });

        window.__gmarkers.push(marker);
        bounds.extend(marker.getPosition());
      });

      if (!bounds.isEmpty()) window.__gmap.fitBounds(bounds);
    };
  </script>
</head>
<body class="bg-zinc-900 text-zinc-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    // Seed demo data with coordinates
    const SITES = [
      { id:"nv-001", title:"Silver Basin Li Project", state:"NV", assetType:"mine",
        commodities:["lithium"], stage:"PFS", readiness:82, timelineMonths:20,
        capexBand:"$150–220M",
        tags:["48C-eligible","Power: 22MW @ 9km","Rail: 4km","EJ: Low"],
        lat: 39.5, lng: -117.1 },
      { id:"tx-011", title:"Red River REE Processing", state:"TX", assetType:"processing",
        commodities:["REE"], stage:"permitting", readiness:74, timelineMonths:18,
        capexBand:"$180–260M",
        tags:["Title 17 fit","Water rights secured","Highway: 2km","EJ: Moderate"],
        lat: 31.8, lng: -99.3 },
      { id:"tn-004", title:"Volta Industrial Shell (Refit)", state:"TN", assetType:"industrial_shell",
        commodities:["graphite","copper"], stage:"construction", readiness:88, timelineMonths:12,
        capexBand:"$65–120M",
        tags:["Grid queue filed","Clear height 34'","Rail spur on site","EJ: Low"],
        lat: 35.9, lng: -86.3 },
      { id:"az-019", title:"Canyon Manganese Hub", state:"AZ", assetType:"mine",
        commodities:["manganese"], stage:"FS", readiness:69, timelineMonths:28,
        capexBand:"$240–330M",
        tags:["Brownfield","Port: 120km","Power: 18MW @ 12km","EJ: Moderate"],
        lat: 34.2, lng: -111.7 },
    ];

    const STATES = ["NV","TX","TN","AZ"];
    const COMMS = ["lithium","REE","graphite","copper","manganese"];
    const TYPES = ["mine","processing","refinery","recycling","industrial_shell"];

    function App(){
      const [query, setQuery] = useState({
        states: new Set(STATES),
        commodities: new Set(COMMS),
        assetTypes: new Set(["mine","processing","industrial_shell"]),
        readinessMin: 65,
        timelineMax: 36,
        ej: new Set(["Low","Moderate","High"]),
      });

      const filtered = useMemo(() =>
        SITES.filter(s =>
          query.states.has(s.state) &&
          s.commodities.some(c => query.commodities.has(c)) &&
          query.assetTypes.has(s.assetType) &&
          s.readiness >= query.readinessMin &&
          s.timelineMonths <= query.timelineMax &&
          s.tags.some(t => Array.from(query.ej).some(lvl => t.includes(`EJ: ${lvl}`)))
        ), [query]
      );

      useEffect(() => {
        // Draw markers for current result set (or stash until map exists)
        if (window.__refreshMarkers) window.__refreshMarkers(filtered);
      }, [filtered]);

      return (
        <div className="min-h-screen bg-zinc-900 text-zinc-100">
          <header className="sticky top-0 z-10 bg-zinc-900/80 backdrop-blur border-b border-zinc-800">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-xl font-semibold tracking-tight">Colossus Maps — MVP Demo</h1>
              <div className="text-sm text-zinc-400">Site-intelligence for U.S. critical minerals & industrial reuse</div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 grid grid-cols-12 gap-4">
            {/* Filters */}
            <aside className="col-span-12 lg:col-span-3 bg-zinc-950 rounded-2xl shadow-sm border border-zinc-800 p-4">
              <h2 className="text-sm font-medium mb-3">Filters</h2>

              <fieldset className="mb-4">
                <legend className="text-xs uppercase tracking-wide text-zinc-400 mb-2">States</legend>
                <div className="flex flex-wrap gap-2">
                  {STATES.map(st => (
                    <button key={st}
                      onClick={()=>toggleSet(query.states, st, setQuery)}
                      className={`px-2 py-1 rounded-full text-sm border transition ${
                        query.states.has(st)
                          ? "bg-zinc-200 text-zinc-900 border-zinc-200"
                          : "border-zinc-700 text-zinc-300 hover:border-zinc-500"
                      }`}>{st}</button>
                  ))}
                </div>
              </fieldset>

              <fieldset className="mb-4">
                <legend className="text-xs uppercase tracking-wide text-zinc-400 mb-2">Commodities</legend>
                <div className="flex flex-wrap gap-2">
                  {COMMS.map(c => (
                    <button key={c}
                      onClick={()=>toggleSet(query.commodities, c, setQuery)}
                      className={`px-2 py-1 rounded-full text-sm border transition ${
                        query.commodities.has(c)
                          ? "bg-zinc-900 border-emerald-500 text-emerald-300"
                          : "border-zinc-700 text-zinc-300 hover:border-zinc-500"
                      }`}>{c}</button>
                  ))}
                </div>
              </fieldset>

              <fieldset className="mb-4">
                <legend className="text-xs uppercase tracking-wide text-zinc-400 mb-2">Asset Types</legend>
                <div className="flex flex-wrap gap-2">
                  {TYPES.map(t => (
                    <button key={t}
                      onClick={()=>toggleSet(query.assetTypes, t, setQuery)}
                      className={`px-2 py-1 rounded-full text-sm border transition ${
                        query.assetTypes.has(t)
                          ? "bg-zinc-900 border-sky-500 text-sky-300"
                          : "border-zinc-700 text-zinc-300 hover:border-zinc-500"
                      }`}>{t.replace("_"," ")}</button>
                  ))}
                </div>
              </fieldset>

              <div className="mb-4">
                <label className="text-xs uppercase tracking-wide text-zinc-400 mb-1 block">
                  Readiness ≥ <span className="text-zinc-200">{query.readinessMin}</span>
                </label>
                <input type="range" min="0" max="100" value={query.readinessMin}
                  onChange={e=>setQuery(q=>({...q, readinessMin:Number(e.target.value)}))}
                  className="w-full accent-emerald-500" />
              </div>

              <div className="mb-2">
                <label className="text-xs uppercase tracking-wide text-zinc-400 mb-1 block">
                  Timeline ≤ <span className="text-zinc-2 00">{query.timelineMax}</span> mo
                </label>
                <input type="range" min="6" max="60" step="6" value={query.timelineMax}
                  onChange={e=>setQuery(q=>({...q, timelineMax:Number(e.target.value)}))}
                  className="w-full accent-sky-500" />
              </div>

              <fieldset className="mt-4">
                <legend className="text-xs uppercase tracking-wide text-zinc-400 mb-2">EJ Risk</legend>
                <div className="flex gap-2">
                  {["Low","Moderate","High"].map(lvl => (
                    <button key={lvl}
                      onClick={()=>toggleSet(query.ej, lvl, setQuery)}
                      className={`px-2 py-1 rounded-full text-sm border transition ${
                        query.ej.has(lvl)
                          ? "bg-zinc-900 border-amber-400 text-amber-300"
                          : "border-zinc-700 text-zinc-300 hover:border-zinc-500"
                      }`}>{lvl}</button>
                  ))}
                </div>
              </fieldset>
            </aside>

            {/* Map + Results */}
            <section className="col-span-12 lg:col-span-9 flex flex-col gap-4">
              <div id="map" className="bg-zinc-950 rounded-2xl shadow-sm border border-zinc-800"></div>

              <div className="grid md:grid-cols-2 gap-4">
                {filtered.map(s => <SiteCard key={s.id} site={s} />)}
                {filtered.length === 0 && (
                  <div className="p-6 rounded-2xl bg-zinc-950 border border-dashed border-zinc-700 text-zinc-400">
                    No sites match these filters. Try lowering Readiness or extending Timeline.
                  </div>
                )}
              </div>
            </section>
          </main>
        </div>
      );
    }

    function SiteCard({ site }) {
      return (
        <div className="rounded-2xl bg-zinc-950 border border-zinc-800 shadow-sm p-4 flex flex-col gap-3">
          <div className="flex items-start justify-between gap-3">
            <div>
              <h3 className="font-semibold leading-tight text-zinc-100">{site.title}</h3>
              <p className="text-sm text-zinc-400">
                {site.state} • {site.assetType.replace("_"," ")} • {site.commodities.join(", ")} • {site.stage}
              </p>
            </div>
            <ScoreBadge value={site.readiness} />
          </div>
          <div className="text-sm text-zinc-300 flex gap-4">
            <span>Timeline: <strong className="text-zinc-100">{site.timelineMonths} mo</strong></span>
            <span>Capex: <strong className="text-zinc-100">{site.capexBand}</strong></span>
          </div>
          <div className="flex flex-wrap gap-2">
            {site.tags.map(t => (
              <span key={t} className="px-2 py-0.5 rounded-full border text-xs border-zinc-700 text-zinc-300">{t}</span>
            ))}
          </div>
          <div className="flex gap-2 mt-1">
            <button className="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm">View Diligence Pack (Sample)</button>
            <button className="px-3 py-1.5 rounded-xl border border-zinc-700 hover:border-zinc-500 text-sm">Request Intro</button>
          </div>
        </div>
      );
    }

    function ScoreBadge({ value }) {
      const color = value >= 80 ? "bg-emerald-600" : value >= 60 ? "bg-amber-500" : "bg-rose-600";
      return (
        <div className="flex items-center gap-2">
          <div className={`w-10 h-10 rounded-full ${color} text-white grid place-items-center font-semibold`}>{value}</div>
        </div>
      );
    }

    function toggleSet(setObj, value, setQuery) {
      const next = new Set(Array.from(setObj));
      if (next.has(value)) next.delete(value); else next.add(value);
      setQuery(q => ({ ...q, [keyOfSet(q, setObj)]: next }));
    }

    function keyOfSet(q, setRef) {
      return Object.entries(q).find(([k,v]) => v === setRef)?.[0];
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>

  <!-- Google Maps JavaScript API (defer only; no async to avoid race) -->
  <script defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZ_wvUHsBJuwTL-TKi6S2-Q1oLdhdAAz4&libraries=places,geometry&callback=initMap">
  </script>
</body>
</html>
